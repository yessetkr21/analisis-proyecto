{% extends "base.html" %}

{% block title %}Cap√≠tulo 2 - Sistemas de Ecuaciones{% endblock %}

{% block header_title %}Cap√≠tulo 2: Sistemas de Ecuaciones Lineales{% endblock %}
{% block header_subtitle %}M√©todos iterativos: Jacobi, Gauss-Seidel y SOR{% endblock %}

{% block content %}
<div class="help-box">
    <h4>Formato de Entrada</h4>
    <p><strong>Matriz A:</strong> Separa filas con ";" y columnas con ",". Ejemplo: <code>10,1,1;2,10,1;2,2,10</code></p>
    <p><strong>Vector b:</strong> Separa elementos con ",". Ejemplo: <code>12,13,14</code></p>
    <p><strong>Vector x0:</strong> (Opcional) Vector inicial. Si no se proporciona, usa el vector cero.</p>
</div>

<div class="metodos-container">
    <div class="metodos-sidebar">
        <h3>M√©todos Disponibles</h3>
        <button class="metodo-btn active" onclick="cambiarMetodo('jacobi')">Jacobi</button>
        <button class="metodo-btn" onclick="cambiarMetodo('gauss-seidel')">Gauss-Seidel</button>
        <button class="metodo-btn" onclick="cambiarMetodo('sor')">SOR</button>
        <hr style="margin: 20px 0; border: 1px solid #e0e0e0;">
        <button class="metodo-btn" onclick="cambiarMetodo('informe-cap2')" style="background: #27ae60; color: white;">üìä Generar Informe</button>
    </div>

    <div class="metodo-content">
        <!-- Jacobi -->
        <div id="jacobi" class="metodo-panel active">
            <h2>M√©todo de Jacobi</h2>
            <form id="form-jacobi">
                <div class="form-group">
                    <label>Matriz A (coeficientes):</label>
                    <input type="text" name="matriz" value="10,1,1;2,10,1;2,2,10" required>
                    <small>Formato: fila1;fila2;fila3 (Ej: 10,1,1;2,10,1;2,2,10)</small>
                </div>
                <div class="form-group">
                    <label>Vector b:</label>
                    <input type="text" name="vector_b" value="12,13,14" required>
                    <small>Formato: b1,b2,b3 (Ej: 12,13,14)</small>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Vector inicial x0 (opcional):</label>
                        <input type="text" name="x0" placeholder="0,0,0">
                        <small>Dejar vac√≠o para usar vector cero</small>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tolerancia:</label>
                        <input type="text" name="tol" value="0.000001" required>
                    </div>
                    <div class="form-group">
                        <label>Iteraciones m√°ximas:</label>
                        <input type="number" name="niter" value="100" required>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="ejecutarMetodoCap2('jacobi')">Ejecutar</button>
            </form>
            <div id="loading-jacobi" class="loading"><div class="spinner"></div></div>
            <div id="resultados-jacobi" class="results-section"></div>
        </div>

        <!-- Gauss-Seidel -->
        <div id="gauss-seidel" class="metodo-panel">
            <h2>M√©todo de Gauss-Seidel</h2>
            <form id="form-gauss-seidel">
                <div class="form-group">
                    <label>Matriz A:</label>
                    <input type="text" name="matriz" value="10,1,1;2,10,1;2,2,10" required>
                </div>
                <div class="form-group">
                    <label>Vector b:</label>
                    <input type="text" name="vector_b" value="12,13,14" required>
                </div>
                <div class="form-group">
                    <label>Vector inicial x0 (opcional):</label>
                    <input type="text" name="x0" placeholder="0,0,0">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tolerancia:</label>
                        <input type="text" name="tol" value="0.000001" required>
                    </div>
                    <div class="form-group">
                        <label>Iteraciones m√°ximas:</label>
                        <input type="number" name="niter" value="100" required>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="ejecutarMetodoCap2('gauss-seidel')">Ejecutar</button>
            </form>
            <div id="loading-gauss-seidel" class="loading"><div class="spinner"></div></div>
            <div id="resultados-gauss-seidel" class="results-section"></div>
        </div>

        <!-- SOR -->
        <div id="sor" class="metodo-panel">
            <h2>M√©todo SOR (Successive Over-Relaxation)</h2>
            <div class="help-box">
                <p><strong>Factor w:</strong> 0 < w < 2</p>
                <ul>
                    <li>w < 1: Subrelajaci√≥n</li>
                    <li>w = 1: Gauss-Seidel est√°ndar</li>
                    <li>w > 1: Sobrerelajaci√≥n (m√°s r√°pido)</li>
                </ul>
                <p>Valor recomendado: 1.5</p>
            </div>
            <form id="form-sor">
                <div class="form-group">
                    <label>Matriz A:</label>
                    <input type="text" name="matriz" value="10,1,1;2,10,1;2,2,10" required>
                </div>
                <div class="form-group">
                    <label>Vector b:</label>
                    <input type="text" name="vector_b" value="12,13,14" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Vector inicial x0 (opcional):</label>
                        <input type="text" name="x0" placeholder="0,0,0">
                    </div>
                    <div class="form-group">
                        <label>Factor de relajaci√≥n w:</label>
                        <input type="number" step="any" name="w" value="1.5" required>
                        <small>Debe estar entre 0 y 2</small>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tolerancia:</label>
                        <input type="text" name="tol" value="0.000001" required>
                    </div>
                    <div class="form-group">
                        <label>Iteraciones m√°ximas:</label>
                        <input type="number" name="niter" value="100" required>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="ejecutarMetodoCap2('sor')">Ejecutar</button>
            </form>
            <div id="loading-sor" class="loading"><div class="spinner"></div></div>
            <div id="resultados-sor" class="results-section"></div>
        </div>

        <!-- Panel de Informe Comparativo Cap 2 -->
        <div id="informe-cap2" class="metodo-panel">
            <h2>üìä Informe Comparativo de M√©todos</h2>
            <div class="help-box">
                <h4>¬øQu√© hace el informe?</h4>
                <p>Ejecuta los 3 m√©todos (Jacobi, Gauss-Seidel y SOR) con la misma matriz y compara:</p>
                <ul>
                    <li>N√∫mero de iteraciones hasta convergencia</li>
                    <li>Error final alcanzado</li>
                    <li>Radio espectral de cada m√©todo</li>
                    <li>Tiempo de ejecuci√≥n</li>
                </ul>
                <p><strong>Resultado:</strong> Identifica cu√°l m√©todo convergi√≥ m√°s r√°pido y con menor error.</p>
            </div>

            <form id="form-informe-cap2">
                <div class="form-group">
                    <label>Matriz A (coeficientes):</label>
                    <input type="text" name="matriz" value="10,1,1;2,10,1;2,2,10" required>
                    <small>Formato: fila1;fila2;fila3 - Ejemplo: 10,1,1;2,10,1;2,2,10</small>
                </div>

                <div class="form-group">
                    <label>Vector b (t√©rminos independientes):</label>
                    <input type="text" name="vector_b" value="12,13,14" required>
                    <small>Formato: b1,b2,b3 - Ejemplo: 12,13,14</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Vector inicial x0 (opcional):</label>
                        <input type="text" name="x0" placeholder="0,0,0">
                        <small>Si vac√≠o, usa vector cero</small>
                    </div>
                    <div class="form-group">
                        <label>Factor w para SOR:</label>
                        <input type="number" step="any" name="w" value="1.5" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Tolerancia:</label>
                        <input type="number" step="any" name="tol" value="1e-6" required>
                    </div>
                    <div class="form-group">
                        <label>Iteraciones m√°ximas:</label>
                        <input type="number" name="niter" value="100" required>
                    </div>
                </div>

                <button type="button" class="btn btn-success" onclick="generarInformeCap2()">üöÄ Generar Informe Comparativo</button>
            </form>

            <div id="loading-informe-cap2" class="loading"><div class="spinner"></div></div>
            <div id="resultados-informe-cap2" class="results-section"></div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function cambiarMetodo(metodo) {
    document.querySelectorAll('.metodo-panel').forEach(p => p.classList.remove('active'));
    document.getElementById(metodo).classList.add('active');
    document.querySelectorAll('.metodo-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
}

async function ejecutarMetodoCap2(metodo) {
    const form = document.getElementById(`form-${metodo}`);
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    document.getElementById(`loading-${metodo}`).classList.add('show');
    document.getElementById(`resultados-${metodo}`).classList.remove('show');

    try {
        const response = await fetch(`/api/capitulo2/${metodo}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        const resultado = await response.json();
        mostrarResultadosCap2(metodo, resultado);
    } catch (error) {
        mostrarError(metodo, error.message);
    } finally {
        document.getElementById(`loading-${metodo}`).classList.remove('show');
    }
}

function mostrarResultadosCap2(metodo, resultado) {
    const div = document.getElementById(`resultados-${metodo}`);
    div.classList.add('show');

    if (!resultado.exito) {
        div.innerHTML = `<div class="result-message error">${resultado.mensaje}</div>`;
        return;
    }

    let html = `<div class="result-message success">${resultado.mensaje}</div>`;
    html += `<div class="result-stats">`;
    html += `<p><strong>Soluci√≥n:</strong> x = [${resultado.solucion.map(x => x.toFixed(6)).join(', ')}]</p>`;
    html += `<p><strong>Iteraciones:</strong> ${resultado.iteraciones}</p>`;
    html += `<p><strong>Radio Espectral:</strong> ${resultado.radio_espectral.toFixed(8)}</p>`;
    html += `<p><strong>Converge:</strong> ${resultado.converge ? 'S√≠' : 'No'} (œÅ < 1)</p>`;
    html += `</div>`;

    // Agregar tabla de iteraciones
    if (resultado.tabla && resultado.tabla.length > 0) {
        html += crearTablaCap2(resultado.tabla);
    }

    div.innerHTML = html;
}

function crearTablaCap2(tabla) {
    if (!tabla || tabla.length === 0) return '';

    const n = tabla[0].x.length; // N√∫mero de variables

    let html = '<div class="table-container"><table><thead><tr>';
    html += '<th>Iteraci√≥n</th>';
    for (let i = 0; i < n; i++) {
        html += `<th>x${i + 1}</th>`;
    }
    html += '<th>Error</th>';
    html += '</tr></thead><tbody>';

    // Filas
    tabla.forEach(fila => {
        html += '<tr>';
        html += `<td>${fila.iter}</td>`;
        fila.x.forEach(val => {
            html += `<td>${val.toFixed(6)}</td>`;
        });
        html += `<td>${fila.error !== null && fila.error !== undefined ? fila.error.toFixed(6) : 'NaN'}</td>`;
        html += '</tr>';
    });

    html += '</tbody></table></div>';
    return html;
}

function mostrarError(metodo, mensaje) {
    const div = document.getElementById(`resultados-${metodo}`);
    div.classList.add('show');
    div.innerHTML = `<div class="result-message error">Error: ${mensaje}</div>`;
}

// ===== INFORME COMPARATIVO CAP√çTULO 2 =====
async function generarInformeCap2() {
    const form = document.getElementById('form-informe-cap2');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    const loadingDiv = document.getElementById('loading-informe-cap2');
    const resultadosDiv = document.getElementById('resultados-informe-cap2');

    loadingDiv.classList.add('show');
    resultadosDiv.classList.remove('show');

    try {
        const response = await fetch('/api/capitulo2/informe', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        const resultado = await response.json();
        mostrarInformeCap2(resultado);
    } catch (error) {
        resultadosDiv.classList.add('show');
        resultadosDiv.innerHTML = `<div class="result-message error">Error: ${error.message}</div>`;
    } finally {
        loadingDiv.classList.remove('show');
    }
}

function mostrarInformeCap2(resultado) {
    const resultadosDiv = document.getElementById('resultados-informe-cap2');
    resultadosDiv.classList.add('show');

    if (!resultado.exito) {
        resultadosDiv.innerHTML = `<div class="result-message error">${resultado.mensaje}</div>`;
        return;
    }

    let html = '<div class="informe-container">';
    html += '<h3>üìä Resultados de la Comparaci√≥n</h3>';

    // Tabla comparativa
    html += '<div class="table-container"><table>';
    html += '<thead><tr>';
    html += '<th>M√©todo</th><th>Estado</th><th>Iteraciones</th><th>Error Final</th>';
    html += '<th>Radio Espectral</th><th>Converge</th><th>Tiempo</th>';
    html += '</tr></thead><tbody>';

    resultado.resultados.forEach(r => {
        if (r.exito) {
            html += '<tr>';
            html += `<td><strong>${r.metodo}</strong></td>`;
            html += `<td><span style="color: #27ae60;">‚úì Exitoso</span></td>`;
            html += `<td>${r.iteraciones}</td>`;
            html += `<td>${r.error.toExponential(4)}</td>`;
            html += `<td>${r.radio_espectral.toFixed(8)}</td>`;
            html += `<td>${r.converge ? '<span style="color: #27ae60;">S√≠ (œÅ < 1)</span>' : '<span style="color: #e74c3c;">No (œÅ ‚â• 1)</span>'}</td>`;
            html += `<td>${(r.tiempo * 1000).toFixed(2)} ms</td>`;
            html += '</tr>';
        } else {
            html += '<tr>';
            html += `<td><strong>${r.metodo}</strong></td>`;
            html += `<td><span style="color: #e74c3c;">‚úó Fall√≥</span></td>`;
            html += `<td colspan="5">${r.error_msg || 'No convergi√≥'}</td>`;
            html += '</tr>';
        }
    });

    html += '</tbody></table></div>';

    // An√°lisis y conclusiones
    html += '<div class="informe-analisis">';
    html += '<h4>üèÜ An√°lisis y Conclusiones</h4>';
    html += '<div class="conclusiones">';
    html += `<p><strong>‚ö° M√©todo m√°s r√°pido (menos iteraciones):</strong> <span class="highlight">${resultado.mejor_iteraciones}</span></p>`;
    html += `<p><strong>üéØ Mejor m√©todo (menor error):</strong> <span class="highlight">${resultado.mejor_error}</span></p>`;
    html += `<p><strong>üìà M√©todos exitosos:</strong> ${resultado.estadisticas.exitosos} de ${resultado.estadisticas.total_metodos}</p>`;

    if (resultado.estadisticas.fallidos > 0) {
        html += `<p><strong>‚ö†Ô∏è M√©todos que fallaron:</strong> ${resultado.estadisticas.fallidos}</p>`;
    }

    html += '<p class="nota">Nota: El radio espectral indica si el m√©todo puede converger (œÅ < 1 garantiza convergencia).</p>';
    html += '</div></div></div>';

    // Estilos
    html += `
    <style>
    .informe-container { margin-top: 20px; }
    .informe-analisis {
        background: #f9f9f9; padding: 20px; border-radius: 8px;
        margin-top: 20px; border-left: 4px solid #27ae60;
    }
    .conclusiones p { margin: 10px 0; font-size: 1.05em; }
    .highlight { color: #27ae60; font-weight: bold; font-size: 1.1em; }
    .nota { font-size: 0.9em; color: #666; font-style: italic; margin-top: 15px; }
    </style>
    `;

    resultadosDiv.innerHTML = html;
}
</script>
{% endblock %}
