{% extends "base.html" %}

{% block title %}Cap√≠tulo 3 - Interpolaci√≥n{% endblock %}

{% block header_title %}Cap√≠tulo 3: Interpolaci√≥n{% endblock %}
{% block header_subtitle %}M√©todos de interpolaci√≥n polinomial y splines{% endblock %}

{% block content %}
<div class="metodos-container">
    <div class="metodos-sidebar">
        <h3>M√©todos Disponibles</h3>
        <button class="metodo-btn active" onclick="cambiarMetodo('vandermonde')">Vandermonde</button>
        <button class="metodo-btn" onclick="cambiarMetodo('newton-inter')">Newton</button>
        <button class="metodo-btn" onclick="cambiarMetodo('lagrange')">Lagrange</button>
        <button class="metodo-btn" onclick="cambiarMetodo('spline-lineal')">Spline Lineal</button>
        <button class="metodo-btn" onclick="cambiarMetodo('spline-cubico')">Spline C√∫bico</button>
        <hr style="margin: 20px 0; border: 1px solid #e0e0e0;">
        <button class="metodo-btn" onclick="cambiarMetodo('informe-cap3')" style="background: #27ae60; color: white;">üìä Generar Informe</button>
    </div>

    <div class="metodo-content">
        <!-- Ayuda General -->
        <div class="ayuda-general-banner">
            <button class="ayuda-toggle" onclick="toggleAyudaGeneral()">
                Formato de Entrada (Click para ayuda)
            </button>
            <div id="ayuda-general-content" class="ayuda-general-content" style="display: none;">
                <h3>Guia de Formato de Entrada - Capitulo 3</h3>

                <div class="ayuda-section">
                    <h4>Formato de Puntos (x, y)</h4>
                    <p><strong>Sintaxis:</strong> Separa puntos con ";" y coordenadas con ","</p>
                    <p><strong>Formato general:</strong> <code>x1,y1;x2,y2;x3,y3;...</code></p>

                    <table class="syntax-table">
                        <tr><th>Numero de Puntos</th><th>Ejemplo</th></tr>
                        <tr><td>2 puntos</td><td><code>0,1;1,2</code></td></tr>
                        <tr><td>3 puntos</td><td><code>0,1;1,2;2,1.5</code></td></tr>
                        <tr><td>4 puntos</td><td><code>0,1;1,2;2,1.5;3,3</code></td></tr>
                        <tr><td>5 puntos</td><td><code>0,1;1,2;2,1.5;3,3;4,2.5</code></td></tr>
                    </table>
                </div>

                <div class="ayuda-section">
                    <h4>Restricciones Importantes</h4>
                    <div class="info-box">
                        <ul>
                            <li><strong>Minimo:</strong> 2 puntos</li>
                            <li><strong>Maximo:</strong> 8 puntos</li>
                            <li><strong>Valores x unicos:</strong> No puede haber valores de x repetidos</li>
                        </ul>
                    </div>
                    <p><strong>Ejemplos validos:</strong></p>
                    <ul>
                        <li><code>0,1;1,2;2,3</code> - OK (x son diferentes: 0, 1, 2)</li>
                        <li><code>-1,5;0,3;1,7</code> - OK (x negativos permitidos)</li>
                        <li><code>0.5,1;1.5,2;2.5,3</code> - OK (decimales permitidos)</li>
                    </ul>
                    <p><strong>Ejemplos invalidos:</strong></p>
                    <ul>
                        <li><code>1,2;1,3;2,4</code> - ERROR (x=1 se repite)</li>
                        <li><code>0,1</code> - ERROR (solo 1 punto, minimo 2)</li>
                    </ul>
                </div>

                <div class="ayuda-section">
                    <h4>Metodos de Interpolacion</h4>
                    <table class="syntax-table">
                        <tr><th>Metodo</th><th>Descripcion</th><th>Cuando Usar</th></tr>
                        <tr>
                            <td><strong>Vandermonde</strong></td>
                            <td>Resuelve sistema usando matriz de Vandermonde</td>
                            <td>Pocos puntos (2-5), fines educativos</td>
                        </tr>
                        <tr>
                            <td><strong>Newton</strong></td>
                            <td>Usa diferencias divididas</td>
                            <td>Mejor estabilidad numerica, puntos no equiespaciados</td>
                        </tr>
                        <tr>
                            <td><strong>Lagrange</strong></td>
                            <td>Formula directa de Lagrange</td>
                            <td>Evaluacion directa, puntos arbitrarios</td>
                        </tr>
                        <tr>
                            <td><strong>Spline Lineal</strong></td>
                            <td>Segmentos de lineas rectas</td>
                            <td>Datos con tendencia lineal por tramos</td>
                        </tr>
                        <tr>
                            <td><strong>Spline Cubico</strong></td>
                            <td>Polinomios de grado 3 suaves</td>
                            <td>Curvas suaves, mejor interpolacion visual</td>
                        </tr>
                    </table>
                </div>

                <div class="ayuda-section">
                    <h4>Grado del Polinomio</h4>
                    <div class="info-box">
                        <p>Para los metodos <strong>Vandermonde, Newton y Lagrange</strong>:</p>
                        <p style="text-align: center; font-size: 1.1em; margin: 10px 0;">
                            <strong>Grado = Numero de puntos - 1</strong>
                        </p>
                        <ul>
                            <li>2 puntos ‚Üí Polinomio de grado 1 (linea recta)</li>
                            <li>3 puntos ‚Üí Polinomio de grado 2 (parabola)</li>
                            <li>4 puntos ‚Üí Polinomio de grado 3 (cubica)</li>
                            <li>n puntos ‚Üí Polinomio de grado n-1</li>
                        </ul>
                        <p class="tip"><strong>Nota:</strong> Polinomios de grado muy alto pueden tener oscilaciones (fenomeno de Runge)</p>
                    </div>
                </div>

                <div class="ayuda-section">
                    <h4>Splines vs Polinomios</h4>
                    <table class="syntax-table">
                        <tr><th>Aspecto</th><th>Polinomios Globales</th><th>Splines</th></tr>
                        <tr>
                            <td>Grado</td>
                            <td>Crece con numero de puntos</td>
                            <td>Fijo (1 o 3)</td>
                        </tr>
                        <tr>
                            <td>Oscilaciones</td>
                            <td>Pueden aparecer (Runge)</td>
                            <td>Minimas o nulas</td>
                        </tr>
                        <tr>
                            <td>Suavidad</td>
                            <td>Muy suave (C‚àû)</td>
                            <td>Lineal: C‚Å∞, Cubico: C¬≤</td>
                        </tr>
                        <tr>
                            <td>Mejor para</td>
                            <td>Pocos puntos, formula exacta</td>
                            <td>Muchos puntos, visualizacion</td>
                        </tr>
                    </table>
                </div>

                <div class="ayuda-section">
                    <h4>Ejemplos Completos</h4>

                    <p><strong>Ejemplo 1: Parabola simple (3 puntos)</strong></p>
                    <ul>
                        <li>Puntos: <code>0,0;1,1;2,0</code></li>
                        <li>Grado: 2 (parabola)</li>
                        <li>Recomendado: Vandermonde, Newton o Lagrange</li>
                    </ul>

                    <p><strong>Ejemplo 2: Datos de temperatura (5 puntos)</strong></p>
                    <ul>
                        <li>Puntos: <code>0,20;1,22;2,25;3,23;4,21</code></li>
                        <li>Horas vs Temperatura</li>
                        <li>Recomendado: Spline Cubico (curva suave)</li>
                    </ul>

                    <p><strong>Ejemplo 3: Datos experimentales (6 puntos)</strong></p>
                    <ul>
                        <li>Puntos: <code>1,2.5;2,3.1;3,4.2;4,3.8;5,5.1;6,5.9</code></li>
                        <li>Muchos puntos, tendencia no lineal</li>
                        <li>Recomendado: Spline Cubico o Newton</li>
                    </ul>

                    <p><strong>Ejemplo 4: Funcion conocida (4 puntos de sen(x))</strong></p>
                    <ul>
                        <li>Puntos: <code>0,0;1.57,1;3.14,0;4.71,-1</code></li>
                        <li>Aproximar sin(x) en [0, 2œÄ]</li>
                        <li>Recomendado: Newton o Lagrange</li>
                    </ul>
                </div>

                <div class="ayuda-section">
                    <h4>Visualizacion con Desmos</h4>
                    <div class="info-box">
                        <p>Todos los metodos generan graficas interactivas con Desmos que muestran:</p>
                        <ul>
                            <li>Puntos originales (marcados en rojo)</li>
                            <li>Polinomio o spline interpolante (curva azul)</li>
                            <li>Ecuacion del polinomio (cuando aplica)</li>
                        </ul>
                        <p class="tip"><strong>Tip:</strong> Usa Desmos para verificar que la interpolacion pasa exactamente por todos los puntos.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vandermonde -->
        <div id="vandermonde" class="metodo-panel active">
            <h2>M√©todo de Vandermonde</h2>
            <form id="form-vandermonde">
                <div class="form-group">
                    <label>Puntos (x,y):</label>
                    <input type="text" name="puntos" value="0,1;1,2;2,1.5;3,3" required>
                    <small>Formato: x1,y1;x2,y2;x3,y3 (Ej: 0,1;1,2;2,1.5;3,3)</small>
                </div>
                <button type="button" class="btn btn-primary" onclick="ejecutarMetodoCap3('vandermonde')">Ejecutar</button>
            </form>
            <div id="loading-vandermonde" class="loading"><div class="spinner"></div></div>
            <div id="resultados-vandermonde" class="results-section"></div>
        </div>

        <!-- Newton -->
        <div id="newton-inter" class="metodo-panel">
            <h2>M√©todo de Newton Interpolante</h2>
            <form id="form-newton-inter">
                <div class="form-group">
                    <label>Puntos (x,y):</label>
                    <input type="text" name="puntos" value="0,1;1,2;2,1.5;3,3" required>
                </div>
                <button type="button" class="btn btn-primary" onclick="ejecutarMetodoCap3('newton')">Ejecutar</button>
            </form>
            <div id="loading-newton-inter" class="loading"><div class="spinner"></div></div>
            <div id="resultados-newton-inter" class="results-section"></div>
        </div>

        <!-- Lagrange -->
        <div id="lagrange" class="metodo-panel">
            <h2>M√©todo de Lagrange</h2>
            <form id="form-lagrange">
                <div class="form-group">
                    <label>Puntos (x,y):</label>
                    <input type="text" name="puntos" value="0,1;1,2;2,1.5;3,3" required>
                </div>
                <button type="button" class="btn btn-primary" onclick="ejecutarMetodoCap3('lagrange')">Ejecutar</button>
            </form>
            <div id="loading-lagrange" class="loading"><div class="spinner"></div></div>
            <div id="resultados-lagrange" class="results-section"></div>
        </div>

        <!-- Spline Lineal -->
        <div id="spline-lineal" class="metodo-panel">
            <h2>Spline Lineal</h2>
            <form id="form-spline-lineal">
                <div class="form-group">
                    <label>Puntos (x,y):</label>
                    <input type="text" name="puntos" value="0,1;1,2;2,1.5;3,3;4,2.5" required>
                </div>
                <button type="button" class="btn btn-primary" onclick="ejecutarMetodoCap3('spline-lineal')">Ejecutar</button>
            </form>
            <div id="loading-spline-lineal" class="loading"><div class="spinner"></div></div>
            <div id="resultados-spline-lineal" class="results-section"></div>
        </div>

        <!-- Spline C√∫bico -->
        <div id="spline-cubico" class="metodo-panel">
            <h2>Spline C√∫bico Natural</h2>
            <form id="form-spline-cubico">
                <div class="form-group">
                    <label>Puntos (x,y):</label>
                    <input type="text" name="puntos" value="0,1;1,2;2,1.5;3,3;4,2.5" required>
                </div>
                <button type="button" class="btn btn-primary" onclick="ejecutarMetodoCap3('spline-cubico')">Ejecutar</button>
            </form>
            <div id="loading-spline-cubico" class="loading"><div class="spinner"></div></div>
            <div id="resultados-spline-cubico" class="results-section"></div>
        </div>

        <!-- Panel de Informe Comparativo Cap 3 -->
        <div id="informe-cap3" class="metodo-panel">
            <h2>üìä Informe Comparativo de M√©todos</h2>
            <div class="help-box">
                <h4>¬øQu√© hace el informe?</h4>
                <p>Ejecuta los 5 m√©todos de interpolaci√≥n con los mismos puntos y compara:</p>
                <ul>
                    <li>Calidad del polinomio interpolante</li>
                    <li>Error de interpolaci√≥n</li>
                    <li>Complejidad computacional</li>
                </ul>
                <p><strong>Resultado:</strong> Identifica cu√°l m√©todo es m√°s adecuado para el conjunto de puntos dado.</p>
            </div>

            <form id="form-informe-cap3">
                <div class="form-group">
                    <label>Puntos (x,y):</label>
                    <input type="text" name="puntos" value="0,1;1,2;2,1.5;3,3;4,2.5" required>
                    <small>Formato: x1,y1;x2,y2;... (Ej: 0,1;1,2;2,1.5;3,3;4,2.5)</small>
                </div>

                <button type="button" class="btn btn-success" onclick="generarInformeCap3()">üöÄ Generar Informe Comparativo</button>
            </form>

            <div id="loading-informe-cap3" class="loading"><div class="spinner"></div></div>
            <div id="resultados-informe-cap3" class="results-section"></div>
        </div>
    </div>
</div>

<div id="grafica-cap3" class="chart-container"></div>
{% endblock %}

{% block extra_js %}
<script>
function cambiarMetodo(metodo) {
    document.querySelectorAll('.metodo-panel').forEach(p => p.classList.remove('active'));
    document.getElementById(metodo).classList.add('active');
    document.querySelectorAll('.metodo-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
}

async function ejecutarMetodoCap3(metodo) {
    const formId = metodo === 'newton' ? 'form-newton-inter' : `form-${metodo}`;
    const loadingId = metodo === 'newton' ? 'loading-newton-inter' : `loading-${metodo}`;
    const resultadosId = metodo === 'newton' ? 'resultados-newton-inter' : `resultados-${metodo}`;

    const form = document.getElementById(formId);
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    document.getElementById(loadingId).classList.add('show');

    try {
        const response = await fetch(`/api/capitulo3/${metodo}`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        const resultado = await response.json();
        mostrarResultadosCap3(resultadosId, resultado);
        graficarInterpolacion(resultado);
    } catch (error) {
        mostrarError(resultadosId, error.message);
    } finally {
        document.getElementById(loadingId).classList.remove('show');
    }
}

function mostrarResultadosCap3(divId, resultado) {
    const div = document.getElementById(divId);
    div.classList.add('show');

    if (!resultado.exito) {
        div.innerHTML = `<div class="result-message error">${resultado.mensaje}</div>`;
        return;
    }

    let html = '<div class="result-message success">Interpolaci√≥n calculada exitosamente</div>';

    if (resultado.polinomio_str) {
        html += `<div class="result-stats"><p><strong>Polinomio:</strong></p><p>${resultado.polinomio_str}</p></div>`;
    }

    if (resultado.segmentos) {
        html += '<div class="result-stats"><h4>Segmentos:</h4><ul>';
        resultado.segmentos.forEach((seg, i) => {
            html += `<li><strong>[${seg.intervalo[0].toFixed(2)}, ${seg.intervalo[1].toFixed(2)}]:</strong> ${seg.polinomio}</li>`;
        });
        html += '</ul></div>';
    }

    div.innerHTML = html;
}

function graficarInterpolacion(resultado) {
    if (!resultado.puntos_grafica) return;

    const trace1 = {
        x: resultado.puntos_originales.x,
        y: resultado.puntos_originales.y,
        mode: 'markers',
        name: 'Puntos dados',
        marker: {size: 10, color: '#e74c3c'}
    };

    const trace2 = {
        x: resultado.puntos_grafica.x,
        y: resultado.puntos_grafica.y,
        type: 'scatter',
        name: 'Interpolaci√≥n',
        line: {color: '#3498db', width: 2}
    };

    const layout = {
        title: 'Interpolaci√≥n',
        xaxis: {title: 'x'},
        yaxis: {title: 'y'},
        hovermode: 'closest'
    };

    Plotly.newPlot('grafica-cap3', [trace1, trace2], layout, {responsive: true});
}

async function compararMetodosCap3() {
    const form = document.getElementById('form-comparacion-cap3');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    document.getElementById('loading-comparacion-cap3').classList.add('show');

    try {
        const response = await fetch('/api/capitulo3/comparar', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        const resultado = await response.json();
        mostrarComparacionCap3(resultado);
    } catch (error) {
        console.error('Error:', error);
    } finally {
        document.getElementById('loading-comparacion-cap3').classList.remove('show');
    }
}

function mostrarComparacionCap3(resultado) {
    const div = document.getElementById('resultados-comparacion-cap3');
    div.classList.add('show');

    let html = '<h3>Comparaci√≥n de M√©todos</h3>';
    html += `<div class="mejor-metodo">Mejor M√©todo: ${resultado.comparacion.mejor_metodo}</div>`;
    html += `<p>${resultado.comparacion.analisis}</p>`;

    div.innerHTML = html;
}

function mostrarError(divId, mensaje) {
    const div = document.getElementById(divId);
    div.classList.add('show');
    div.innerHTML = `<div class="result-message error">Error: ${mensaje}</div>`;
}

// ===== INFORME COMPARATIVO CAP√çTULO 3 =====
async function generarInformeCap3() {
    const form = document.getElementById('form-informe-cap3');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    const loadingDiv = document.getElementById('loading-informe-cap3');
    const resultadosDiv = document.getElementById('resultados-informe-cap3');

    loadingDiv.classList.add('show');
    resultadosDiv.classList.remove('show');

    try {
        const response = await fetch('/api/capitulo3/informe', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(data)
        });

        const resultado = await response.json();
        mostrarInformeCap3(resultado);
    } catch (error) {
        resultadosDiv.classList.add('show');
        resultadosDiv.innerHTML = `<div class="result-message error">Error: ${error.message}</div>`;
    } finally {
        loadingDiv.classList.remove('show');
    }
}

function mostrarInformeCap3(resultado) {
    const resultadosDiv = document.getElementById('resultados-informe-cap3');
    resultadosDiv.classList.add('show');

    if (!resultado.exito) {
        resultadosDiv.innerHTML = `<div class="result-message error">${resultado.mensaje}</div>`;
        return;
    }

    let html = '<div class="informe-container">';
    html += '<h3>üìä Informe Comparativo - Cap√≠tulo 3</h3>';

    // Tabla comparativa
    html += '<div class="table-container"><table>';
    html += '<thead><tr>';
    html += '<th>M√©todo</th><th>Estado</th><th>Error Promedio</th><th>Tiempo (ms)</th><th>Polinomio/Spline</th>';
    html += '</tr></thead><tbody>';

    resultado.resultados.forEach(r => {
        if (r.exito) {
            html += '<tr>';
            html += `<td><strong>${r.metodo}</strong></td>`;
            html += `<td><span style="color: #27ae60;">‚úì Exitoso</span></td>`;

            // Mostrar error promedio
            if (r.error_promedio !== null && r.error_promedio !== undefined) {
                const errorFormatted = r.error_promedio.toExponential(2);
                html += `<td><code>${errorFormatted}</code></td>`;
            } else {
                html += `<td><span style="color: #95a5a6;">N/A</span></td>`;
            }

            html += `<td>${(r.tiempo * 1000).toFixed(2)}</td>`;
            html += `<td><code style="font-size: 0.85em; max-width: 250px; display: block; overflow: hidden; text-overflow: ellipsis;">${r.polinomio ? r.polinomio.substring(0, 40) + '...' : 'N/A'}</code></td>`;
            html += '</tr>';
        } else {
            html += '<tr>';
            html += `<td><strong>${r.metodo}</strong></td>`;
            html += `<td><span style="color: #e74c3c;">‚úó Fall√≥</span></td>`;
            html += `<td colspan="3">${r.error_msg || 'Error desconocido'}</td>`;
            html += '</tr>';
        }
    });

    html += '</tbody></table></div>';

    // An√°lisis y conclusiones
    html += '<div class="informe-analisis">';
    html += '<h4>üèÜ An√°lisis y Conclusiones</h4>';
    html += '<div class="conclusiones">';

    // Mostrar las tres m√©tricas principales
    html += `<p><strong>üéØ Mejor M√©todo General:</strong> <span class="highlight-best">${resultado.mejor_metodo}</span></p>`;
    html += `<p><strong>‚ö° M√©todo m√°s r√°pido:</strong> <span class="highlight-rapido">${resultado.mas_rapido}</span> (${(resultado.estadisticas.tiempo_minimo * 1000).toFixed(2)} ms)</p>`;

    if (resultado.menor_error && resultado.menor_error !== 'N/A') {
        const errorMin = resultado.estadisticas.error_minimo ? resultado.estadisticas.error_minimo.toExponential(2) : 'N/A';
        html += `<p><strong>üìâ M√©todo con menor error:</strong> <span class="highlight-error">${resultado.menor_error}</span> (${errorMin})</p>`;
    }

    html += `<p><strong>üìà M√©todos exitosos:</strong> ${resultado.estadisticas.exitosos} de ${resultado.estadisticas.total_metodos}</p>`;

    html += '<div class="recomendaciones">';
    html += '<h5>üí° Recomendaciones</h5>';
    html += '<ul>';
    html += '<li><strong>Vandermonde, Newton y Lagrange:</strong> Generan el mismo polinomio interpolador de grado n-1 con error de interpolaci√≥n ~0 (precisi√≥n de m√°quina)</li>';
    html += '<li><strong>Spline Lineal:</strong> Conecta puntos con l√≠neas rectas, m√°s simple pero menos suave. √ötil para datos discretos</li>';
    html += '<li><strong>Spline C√∫bico:</strong> M√°s suave y natural, recomendado para datos con variaci√≥n continua. Mejor para visualizaci√≥n</li>';
    html += '<li><strong>Rendimiento:</strong> Para interpolaci√≥n polinomial, elige el m√©todo m√°s r√°pido (generalmente Lagrange o Newton)</li>';
    html += '</ul>';
    html += '</div>';

    if (resultado.estadisticas.fallidos > 0) {
        html += `<p><strong>‚ö†Ô∏è M√©todos que fallaron:</strong> ${resultado.estadisticas.fallidos}</p>`;
    }

    html += '</div></div></div>';

    // Estilos
    html += `
    <style>
    .informe-container { margin-top: 20px; }
    .informe-analisis {
        background: #f9f9f9; padding: 20px; border-radius: 8px;
        margin-top: 20px; border-left: 4px solid #9b59b6;
    }
    .conclusiones p { margin: 10px 0; font-size: 1.05em; }
    .highlight { color: #9b59b6; font-weight: bold; font-size: 1.1em; }
    .highlight-best {
        color: #27ae60; font-weight: bold; font-size: 1.2em;
        background: #d5f4e6; padding: 4px 12px; border-radius: 4px;
    }
    .highlight-rapido {
        color: #3498db; font-weight: bold; font-size: 1.05em;
    }
    .highlight-error {
        color: #e67e22; font-weight: bold; font-size: 1.05em;
    }
    .recomendaciones {
        background: white; padding: 15px; border-radius: 6px; margin-top: 15px;
        border-left: 3px solid #3498db;
    }
    .recomendaciones ul { margin: 10px 0; padding-left: 25px; }
    .recomendaciones li { margin: 8px 0; line-height: 1.5; }
    .table-container {
        overflow-x: auto;
        margin: 15px 0;
    }
    .table-container table {
        width: 100%;
        border-collapse: collapse;
    }
    .table-container th {
        background: #9b59b6;
        color: white;
        padding: 12px;
        text-align: left;
        font-weight: 600;
    }
    .table-container td {
        padding: 10px 12px;
        border-bottom: 1px solid #ecf0f1;
    }
    .table-container tr:hover {
        background: #f8f9fa;
    }
    </style>
    `;

    resultadosDiv.innerHTML = html;
}
</script>
{% endblock %}
